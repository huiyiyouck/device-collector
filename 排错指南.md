# 排错指南

## 日志级别配置

代码已添加可配置的日志系统，可以通过环境变量 `LOG_LEVEL` 控制日志输出级别。

### 日志级别说明

| 级别 | 说明 | 适用场景 |
|------|------|----------|
| `silent` | 完全静默，不输出任何日志 | 极低 IO 需求 |
| `error` | 仅输出错误日志（默认） | 生产环境推荐 |
| `warn` | 输出警告和错误日志 | 需要监控警告 |
| `info` | 输出信息、警告和错误日志 | 需要了解运行状态 |
| `debug` | 输出所有日志 | **排错时使用** |

### 配置方法

#### 方法1：在 .env 文件中配置

编辑 `.env` 文件，添加或修改：

```env
LOG_LEVEL=debug
```

#### 方法2：启动时指定

```bash
LOG_LEVEL=debug npm start
```

#### 方法3：临时启用调试模式

```bash
# Linux/Mac
export LOG_LEVEL=debug
npm start

# Windows
set LOG_LEVEL=debug
npm start
```

## 排错步骤

### 1. 启用调试日志

```bash
# 在 .env 文件中设置
LOG_LEVEL=debug

# 或启动时指定
LOG_LEVEL=debug npm start
```

### 2. 查看日志输出

启用 `debug` 级别后，会输出以下详细信息：

- ✅ 服务器启动信息
- ✅ 数据库连接和操作详情
- ✅ 微信 JS-SDK 配置过程
- ✅ 地图 API 调用详情
- ✅ 地址获取过程
- ✅ 请求处理详情
- ✅ 错误堆栈信息

### 3. 常见问题排查

#### 问题1：数据库连接失败

**查看日志：**
```
[ERROR] DB Error: ECONNREFUSED - connect ECONNREFUSED
```

**解决方法：**
- 检查数据库服务是否运行
- 检查 `DATABASE_URL` 配置是否正确
- 检查数据库网络连接

#### 问题2：微信 JS-SDK 配置失败

**查看日志：**
```
[DEBUG] 获取微信JS-SDK配置失败: ...
```

**解决方法：**
- 检查 `WX_APPID` 和 `WX_APPSECRET` 是否正确
- 检查微信公众平台 JS 接口安全域名是否配置
- 检查网络连接

#### 问题3：地图 API 调用失败

**查看日志：**
```
[WARN] 百度地图API错误: 210 - IP白名单限制
[WARN] 高德地址获取失败
```

**解决方法：**
- 检查 API Key 是否正确
- 检查 IP 白名单设置
- 检查 API 配额是否用完

#### 问题4：地址获取失败

**查看日志：**
```
[WARN] 高德地址获取失败 - 坐标: (39.9, 116.4)
```

**解决方法：**
- 检查坐标是否正确
- 检查地图 API 服务是否正常
- 检查网络连接

## 日志输出示例

### error 级别（默认）

```
[ERROR] DB Error: 23505 - duplicate key value violates unique constraint
[ERROR] 保存到数据库失败 - IP: 192.168.1.100, 错误: ...
```

### debug 级别（排错时）

```
[INFO] 服务器已启动，监听端口 3000
[INFO] 访问地址: http://localhost:3000
[INFO] 日志级别: DEBUG
[DEBUG] 处理微信配置请求出错: ...
[DEBUG] 获取微信JS-SDK配置失败: ...
[DEBUG] 获取百度地图地址信息失败: ...
[DEBUG] 获取高德地图地址信息失败: ...
[WARN] 高德地址获取失败
[ERROR] DB Error: 23505 - duplicate key value violates unique constraint
[DEBUG]   PostgreSQL详情: Key (id)=(123) already exists.
[DEBUG]   提示: 请检查唯一约束
[DEBUG]   错误详情: {
  "message": "...",
  "code": "23505",
  ...
}
```

## 性能建议

### 生产环境

```env
LOG_LEVEL=error
```

- 只输出关键错误
- 最小化 IO 操作
- 不影响 SSH 连接

### 开发/测试环境

```env
LOG_LEVEL=info
```

- 输出运行状态信息
- 便于了解系统运行情况

### 排错时

```env
LOG_LEVEL=debug
```

- 输出所有详细信息
- 便于定位问题
- **注意：会产生大量日志，可能影响性能**

## 快速排错命令

```bash
# 1. 启用调试日志
export LOG_LEVEL=debug

# 2. 重启服务
npm start

# 3. 查看实时日志（如果需要）
tail -f /path/to/logfile  # 如果有日志文件

# 4. 测试功能
curl http://localhost:3000/health

# 5. 查看错误
# 错误会显示在控制台，带有 [ERROR] 或 [WARN] 标记
```

## 注意事项

1. **排错完成后**：记得将 `LOG_LEVEL` 改回 `error`，避免产生过多日志
2. **生产环境**：建议使用 `error` 级别，保持最小日志输出
3. **性能影响**：`debug` 级别会产生大量日志，可能影响性能，仅用于排错

## 日志位置

- **控制台输出**：日志直接输出到运行服务的终端
- **如果使用 PM2**：可以使用 `pm2 logs` 查看日志
- **如果使用 systemd**：可以使用 `journalctl -u your-service` 查看日志

