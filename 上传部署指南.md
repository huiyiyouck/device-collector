# 上传部署指南

## 方法一：使用部署脚本（推荐）

### 1. 给脚本添加执行权限

```bash
chmod +x deploy.sh
```

### 2. 执行部署脚本

```bash
./deploy.sh user@host:/path/to/deploy
```

**示例：**
```bash
./deploy.sh root@192.168.1.100:/opt/device-collector
./deploy.sh ubuntu@your-server.com:/home/ubuntu/device-collector
```

脚本会自动：
- 上传所有代码文件
- 在服务器上安装依赖
- 提供后续配置提示

---

## 方法二：手动上传（使用 scp）

### 1. 在服务器上创建目录

```bash
ssh user@host
mkdir -p /path/to/device-collector
cd /path/to/device-collector
```

### 2. 上传文件

在本地项目目录执行：

```bash
# 上传单个文件
scp server.js user@host:/path/to/device-collector/
scp db.js user@host:/path/to/device-collector/
scp app.js user@host:/path/to/device-collector/
scp index.html user@host:/path/to/device-collector/
scp styles.css user@host:/path/to/device-collector/
scp package.json user@host:/path/to/device-collector/
scp schema.sql user@host:/path/to/device-collector/

# 或一次性上传所有文件（排除 node_modules）
scp -r *.js *.html *.css *.json *.sql *.md user@host:/path/to/device-collector/
```

### 3. 在服务器上安装依赖

```bash
ssh user@host
cd /path/to/device-collector
npm install --production
```

---

## 方法三：使用 rsync（推荐，支持增量同步）

### 1. 同步文件到服务器

```bash
rsync -avz --exclude 'node_modules' --exclude '.env' \
  --exclude '.git' \
  ./ user@host:/path/to/device-collector/
```

**参数说明：**
- `-a`: 归档模式，保持文件属性
- `-v`: 详细输出
- `-z`: 压缩传输
- `--exclude`: 排除不需要的文件

### 2. 在服务器上安装依赖

```bash
ssh user@host
cd /path/to/device-collector
npm install --production
```

---

## 方法四：使用 Git（如果服务器有 Git）

### 1. 在服务器上克隆或拉取

```bash
ssh user@host
cd /path/to
git clone git@github.com:huiyiyouck/device-collector.git
# 或如果已存在，拉取更新
cd device-collector
git pull
```

### 2. 安装依赖

```bash
npm install --production
```

---

## 服务器端配置

### 1. 创建 .env 文件

```bash
ssh user@host
cd /path/to/device-collector
nano .env  # 或使用 vi/vim
```

**配置内容：**
```env
# 数据库配置
DATABASE_URL=postgresql://user:password@host:5432/database

# 微信配置
WX_APPID=wxbef604f4e423653d
WX_APPSECRET=1ad1cb9e8bda85a6565863a3d16380fc
WX_REDIRECT_URI=http://your-domain.com/

# 地图 API Key（可选）
AMAP_KEY=
BAIDU_KEY=
TENCENT_KEY=

# 服务器端口
PORT=3000

# 日志级别（error=生产环境, debug=排错时）
LOG_LEVEL=error
```

### 2. 初始化数据库

```bash
psql -U your_user -d your_database -f schema.sql
```

### 3. 测试启动

```bash
npm start
```

如果正常，按 `Ctrl+C` 停止，然后使用进程管理器启动。

---

## 使用 PM2 管理进程（推荐）

### 1. 安装 PM2

```bash
npm install -g pm2
```

### 2. 启动服务

```bash
cd /path/to/device-collector
pm2 start server.js --name device-collector
```

### 3. 查看状态

```bash
pm2 status
pm2 logs device-collector
```

### 4. 设置开机自启

```bash
pm2 startup
pm2 save
```

### 5. 其他常用命令

```bash
pm2 restart device-collector  # 重启
pm2 stop device-collector     # 停止
pm2 delete device-collector   # 删除
```

---

## 使用 systemd 管理服务（可选）

### 1. 创建服务文件

```bash
sudo nano /etc/systemd/system/device-collector.service
```

### 2. 服务配置内容

```ini
[Unit]
Description=Device Collector Service
After=network.target postgresql.service

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/device-collector
Environment="NODE_ENV=production"
EnvironmentFile=/path/to/device-collector/.env
ExecStart=/usr/bin/node /path/to/device-collector/server.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 3. 启用并启动服务

```bash
sudo systemctl daemon-reload
sudo systemctl enable device-collector
sudo systemctl start device-collector
sudo systemctl status device-collector
```

---

## 防火墙配置

如果服务器有防火墙，需要开放端口：

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 3000/tcp

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload

# 或直接编辑 iptables
sudo iptables -A INPUT -p tcp --dport 3000 -j ACCEPT
```

---

## 验证部署

### 1. 检查服务是否运行

```bash
curl http://localhost:3000/health
# 应该返回: {"ok":true}
```

### 2. 检查端口监听

```bash
netstat -tlnp | grep 3000
# 或
ss -tlnp | grep 3000
```

### 3. 查看日志

```bash
# 如果使用 PM2
pm2 logs device-collector

# 如果使用 systemd
sudo journalctl -u device-collector -f

# 如果直接运行
# 日志会输出到控制台
```

---

## 排错

### 如果服务无法启动

1. **检查端口是否被占用**
```bash
lsof -i :3000
# 或
netstat -tlnp | grep 3000
```

2. **检查数据库连接**
```bash
# 测试数据库连接
psql $DATABASE_URL -c "SELECT 1;"
```

3. **启用调试日志**
```bash
# 在 .env 中设置
LOG_LEVEL=debug

# 重启服务查看详细日志
```

4. **查看错误日志**
```bash
# PM2
pm2 logs device-collector --err

# systemd
sudo journalctl -u device-collector -n 50
```

---

## 快速部署命令总结

```bash
# 1. 上传代码（使用 rsync）
rsync -avz --exclude 'node_modules' --exclude '.env' \
  --exclude '.git' \
  ./ user@host:/path/to/device-collector/

# 2. SSH 到服务器
ssh user@host

# 3. 进入项目目录
cd /path/to/device-collector

# 4. 安装依赖
npm install --production

# 5. 配置 .env 文件
nano .env

# 6. 初始化数据库
psql -U user -d database -f schema.sql

# 7. 使用 PM2 启动
pm2 start server.js --name device-collector
pm2 save
```

---

## 注意事项

1. **不要上传 .env 文件**：包含敏感信息，应在服务器上单独创建
2. **不要上传 node_modules**：在服务器上运行 `npm install` 安装
3. **生产环境使用 LOG_LEVEL=error**：减少日志输出
4. **使用进程管理器**：PM2 或 systemd，确保服务稳定运行
5. **配置防火墙**：只开放必要端口
6. **定期备份**：数据库和配置文件

